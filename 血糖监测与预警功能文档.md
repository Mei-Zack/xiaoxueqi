# 血糖监测与预警功能实现文档

## 功能概述

血糖监测与预警功能允许系统从用户的连续血糖监测设备(CGM)获取血糖数据，并通过本地的Ollama大语言模型(deepseek-r1:1.5b)进行分析和预警。该功能支持多种血糖监测设备，包括Freestyle Libre、Dexcom等，可以定期自动获取数据并在检测到异常时生成预警消息。

## 系统架构

系统由以下几个主要组件构成：

1. **血糖监测服务(GlucoseMonitorService)**：负责从设备获取血糖数据、分析数据并生成预警
2. **定时任务调度器(GlucoseMonitorScheduler)**：负责定期执行血糖数据获取和分析任务
3. **API端点(glucose_monitor)**：提供HTTP接口，允许用户手动获取数据、注册设备等
4. **Ollama服务(OllamaService)**：提供大语言模型能力，用于生成个性化预警消息

### 技术栈

- **后端框架**：FastAPI
- **数据库**：MySQL (使用项目数据库 `mysql+pymysql://root:65353804778@localhost/diabetes_assistant`)
- **AI模型**：Ollama (deepseek-r1:1.5b)
- **定时任务**：Python线程和asyncio

## 核心功能

### 1. 设备数据获取

- 支持多种血糖监测设备(Freestyle Libre, Dexcom, Medtronic)
- 提供统一的数据获取接口
- 自动将设备数据转换为系统内部格式

### 2. 血糖数据分析

- 检测低血糖和高血糖情况
- 检测血糖快速上升和下降
- 生成统计数据(平均值、最大值、最小值等)

### 3. 智能预警

- 基于分析结果生成个性化预警消息
- 使用本地Ollama大语言模型(deepseek-r1:1.5b)
- 预警消息包含当前状态、风险和建议措施

### 4. 自动同步

- 支持定期自动从设备获取数据
- 可配置同步间隔(默认15分钟)
- 支持设备注册和取消注册

### 5. 个性化饮食建议

- 基于血糖数据分析生成个性化饮食建议
- 推荐适合当前血糖状态的食物
- 提供餐前、餐后饮食指导
- 根据血糖波动模式调整碳水化合物摄入建议

## 数据库集成

系统使用项目的MySQL数据库进行数据存储，连接字符串为：
```
mysql+pymysql://root:65353804778@localhost/diabetes_assistant
```

### glucose_records表结构

| 字段名 | 类型 | 描述 |
|-------|------|------|
| id | VARCHAR(36) | 主键 |
| user_id | VARCHAR(36) | 外键，关联用户 |
| glucose_value | FLOAT | 血糖值(mmol/L) |
| measurement_time | DATETIME | 测量时间 |
| measurement_type | VARCHAR(50) | 测量类型(空腹/餐后等) |
| notes | TEXT | 备注 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

## API接口文档

### 1. 获取设备数据

```
POST /api/v1/glucose-monitor/device-data
```

请求体:
```json
{
  "device_type": "freestyle_libre",
  "params": {
    "db_path": "/path/to/trident.realm",
    "encryption_key": "your-encryption-key"
  }
}
```

响应:
```json
[
  {
    "timestamp": "2025-07-06T10:30:00",
    "value": 7.2,
    "unit": "mmol/L"
  },
  // 更多血糖记录...
]
```

### 2. 导入设备数据

```
POST /api/v1/glucose-monitor/import-device-data
```

请求体:
```json
{
  "device_type": "dexcom",
  "params": {
    "username": "your-dexcom-username",
    "password": "your-dexcom-password"
  }
}
```

响应:
```json
{
  "status": "success",
  "message": "成功导入24条血糖记录",
  "imported_count": 24
}
```

### 3. 分析血糖数据

```
POST /api/v1/glucose-monitor/analyze
```

请求体:
```json
{
  "hours": 24
}
```

响应:
```json
{
  "status": "ok",
  "statistics": {
    "average": 7.2,
    "max": 10.5,
    "min": 4.2,
    "count": 24,
    "period_hours": 24
  },
  "alerts": [
    {
      "type": "high_glucose",
      "value": 10.5,
      "threshold": 10.0,
      "timestamp": "2025-07-06T15:30:00",
      "severity": "medium"
    }
  ],
  "has_alerts": true,
  "alert_message": "您的血糖在今天下午3:30达到了10.5 mmol/L，略高于正常范围。建议检查您最近的饮食，并考虑适当运动来帮助降低血糖。如果血糖持续偏高，请咨询医生。"
}
```

### 4. 注册设备

```
POST /api/v1/glucose-monitor/register-device
```

请求体:
```json
{
  "device_type": "freestyle_libre",
  "params": {
    "db_path": "/path/to/trident.realm",
    "encryption_key": "your-encryption-key"
  },
  "enable_auto_sync": true
}
```

响应:
```json
{
  "status": "success",
  "message": "成功注册freestyle_libre设备",
  "auto_sync": true
}
```

### 5. 取消注册设备

```
POST /api/v1/glucose-monitor/unregister-device
```

响应:
```json
{
  "status": "success",
  "message": "成功取消注册设备"
}
```

### 6. 获取支持的设备列表

```
GET /api/v1/glucose-monitor/supported-devices
```

响应:
```json
{
  "devices": ["freestyle_libre", "dexcom", "medtronic"]
}
```

### 7. 获取饮食建议 `POST /api/v1/glucose-monitor/diet-suggestions`

**请求体**:
```json
{
  "glucose_data": {
    "recent_average": 7.2,
    "fasting_average": 6.5,
    "after_meal_average": 8.1,
    "has_high_glucose": true,
    "has_low_glucose": false,
    "glucose_variability": "medium"
  },
  "user_preferences": {
    "diet_type": "low_carb",
    "allergies": ["nuts", "seafood"],
    "favorite_foods": ["vegetables", "chicken", "berries"]
  },
  "meal_type": "breakfast" // 可选值: breakfast, lunch, dinner, snack
}
```

**响应**:
```json
{
  "status": "success",
  "suggestions": {
    "general_advice": "您的血糖平均值略高，建议减少碳水化合物摄入，增加蛋白质和健康脂肪的比例。",
    "recommended_foods": [
      {
        "name": "全麦面包",
        "gi": 50,
        "benefits": "低GI值，有助于稳定血糖",
        "portion": "1-2片"
      },
      {
        "name": "鸡蛋",
        "gi": 0,
        "benefits": "优质蛋白质，不影响血糖",
        "portion": "1-2个"
      },
      {
        "name": "牛油果",
        "gi": 15,
        "benefits": "健康脂肪，有助于减缓碳水吸收",
        "portion": "半个"
      }
    ],
    "foods_to_avoid": [
      {
        "name": "白面包",
        "gi": 75,
        "reason": "高GI值，会导致血糖快速上升"
      },
      {
        "name": "果汁",
        "gi": 68,
        "reason": "含糖量高，缺乏膳食纤维"
      }
    ],
    "meal_plan_example": "早餐建议：全麦面包2片 + 煮鸡蛋1个 + 牛油果半个 + 无糖希腊酸奶100g"
  }
}
```

### 8. 获取快速饮食建议 `GET /api/v1/glucose-monitor/quick-diet-suggestions`

**查询参数**:
- `glucose_value`: 当前血糖值，必填
- `meal_type`: 餐食类型(breakfast/lunch/dinner/snack)，必填
- `is_before_meal`: 是否餐前(true/false)，必填

**响应**:
```json
{
  "status": "success",
  "current_status": "您的当前血糖为7.8 mmol/L，属于餐后正常范围上限。",
  "quick_suggestion": "建议选择低GI食物，控制碳水摄入，增加蔬菜比例。",
  "recommended_foods": ["全麦面包", "鸡蛋", "牛油果", "希腊酸奶"],
  "foods_to_avoid": ["白米饭", "甜点", "含糖饮料"]
}
```

## 设备集成说明

### Freestyle Libre

Freestyle Libre设备的集成基于以下文章的方法：
https://frdmtoplay.com/freeing-glucose-data-from-the-freestyle-libre-3/

要获取Freestyle Libre的数据，需要提供以下参数：
- `db_path`: RealmDB文件路径
- `encryption_key`: 解密密钥

### Dexcom

Dexcom设备的集成基于Dexcom Share API：
https://github.com/coderkearns/dexcom

要获取Dexcom的数据，需要提供以下参数：
- `username`: Dexcom账号用户名
- `password`: Dexcom账号密码

## 预警规则

系统使用以下规则进行血糖预警：

1. **低血糖预警**：血糖值低于3.9 mmol/L
2. **高血糖预警**：血糖值高于10.0 mmol/L
3. **快速下降预警**：血糖下降速率超过2.0 mmol/L/小时
4. **快速上升预警**：血糖上升速率超过2.5 mmol/L/小时

预警严重程度分为：
- **高**：低血糖值低于2.9 mmol/L或高血糖值高于12.0 mmol/L
- **中**：其他预警情况

## 使用示例

### 1. 手动获取和分析血糖数据

```python
import requests
import json

# 获取设备数据
response = requests.post(
    "http://localhost:8000/api/v1/glucose-monitor/device-data",
    json={
        "device_type": "freestyle_libre",
        "params": {
            "db_path": "/path/to/trident.realm",
            "encryption_key": "your-encryption-key"
        }
    },
    headers={"Authorization": "Bearer your-token"}
)
glucose_data = response.json()
print(f"获取到{len(glucose_data)}条血糖记录")

# 分析血糖数据
response = requests.post(
    "http://localhost:8000/api/v1/glucose-monitor/analyze",
    json={"hours": 24},
    headers={"Authorization": "Bearer your-token"}
)
analysis = response.json()

if analysis["has_alerts"]:
    print(f"预警消息: {analysis['alert_message']}")
else:
    print("血糖状态正常，无需预警")
```

### 2. 注册设备并启用自动同步

```python
import requests

# 注册设备
response = requests.post(
    "http://localhost:8000/api/v1/glucose-monitor/register-device",
    json={
        "device_type": "dexcom",
        "params": {
            "username": "your-dexcom-username",
            "password": "your-dexcom-password"
        },
        "enable_auto_sync": true
    },
    headers={"Authorization": "Bearer your-token"}
)
print(response.json()["message"])
```

## 部署说明

1. **环境要求**：
   - Python 3.7+
   - MySQL数据库
   - Ollama服务(运行deepseek-r1:1.5b模型)

2. **启动命令**：
   ```
   cd backend
   python main.py
   ```

3. **Ollama设置**：
   - 确保Ollama服务已启动并加载了deepseek-r1:1.5b模型
   - 默认Ollama服务地址为http://localhost:11434

## 注意事项

1. **设备支持**：目前系统提供了设备集成的框架，但实际实现需要根据具体设备进行开发。当前版本使用模拟数据进行演示。

2. **预警通知**：系统目前只记录预警日志，实际应用中可以扩展为发送短信、推送通知等。

3. **数据安全**：血糖数据属于敏感健康信息，请确保系统部署在安全环境中，并遵循相关法规要求。

4. **模型要求**：预警消息生成需要Ollama服务和deepseek-r1:1.5b模型，如果模型不可用，系统将使用基本的预警消息。

## 未来改进方向

1. **实现真实设备集成**：基于参考资料完成Freestyle Libre和Dexcom的实际集成

2. **增强预警机制**：添加更多预警规则，如血糖波动性分析

3. **多渠道通知**：实现短信、邮件、移动应用推送等多种预警通知方式

4. **预警历史记录**：保存历史预警记录，便于用户和医生回顾

5. **个性化预警阈值**：允许用户或医生设置个性化的预警阈值

6. **饮食建议个性化**：基于用户的饮食习惯、文化背景和个人喜好进一步优化饮食建议

7. **餐后血糖预测**：根据食物成分和用户历史数据，预测特定食物摄入后的血糖反应

8. **AI辅助膳食规划**：使用机器学习优化一日三餐的食物组合，实现血糖稳定和营养均衡 